<!-- templates/index.html (Versão com Zoom Padrão 8) -->

<!DOCTYPE html>
<html>
<head>
    <title>Dashboard de Análise Criminal - Ceará</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        :root {
            --sidebar-width: 320px; --sidebar-bg: #2c3e50; --sidebar-text-color: #ecf0f1;
            --sidebar-header-bg: #34495e; --accent-color: #3498db;
        }
        html, body { height: 100%; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        #map { width: 100%; height: 100%; transition: margin-left 0.3s; background-color: #f0f0f0; }
        .sidebar {
            height: 100%; width: var(--sidebar-width ); position: fixed; z-index: 1001; top: 0; left: 0;
            background-color: var(--sidebar-bg); overflow-y: auto; transition: transform 0.3s; padding-top: 20px;
            box-shadow: 3px 0 6px rgba(0,0,0,0.2); transform: translateX(calc(-1 * var(--sidebar-width)));
        }
        .sidebar.open { transform: translateX(0); }
        #map.sidebar-open { margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); }
        .open-btn {
            font-size: 24px; cursor: pointer; background-color: white; color: #333; padding: 8px 15px;
            border: none; position: absolute; top: 10px; left: 10px;
            z-index: 1002; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: left 0.3s;
        }
        .open-btn.shifted { left: calc(var(--sidebar-width) + 10px); }
        .accordion {
            background-color: var(--sidebar-header-bg); color: var(--sidebar-text-color); cursor: pointer;
            padding: 15px; width: 100%; border: none; text-align: left; outline: none;
            font-size: 16px; transition: 0.4s; display: block;
        }
        .accordion:hover, .accordion.active { background-color: var(--accent-color); }
        .accordion::after { content: '\25B6'; font-size: 13px; color: var(--sidebar-text-color); float: right; margin-left: 5px; transition: transform 0.3s; }
        .accordion.active::after { transform: rotate(90deg); }
        
        .panel, .sub-panel {
            display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.3s ease-out; overflow: hidden;
        }
        .panel.open, .sub-panel.open { grid-template-rows: 1fr; }
        .panel-content, .sub-panel-content { min-height: 0; padding: 0 18px; }
        .panel.open { margin-bottom: 5px; }

        .sub-accordion {
            color: var(--sidebar-text-color); cursor: pointer; font-weight: bold; padding: 10px 0; width: 100%; display: block;
        }
        .sub-accordion::after { content: '\25B6'; font-size: 12px; float: right; transition: transform 0.3s; }
        .sub-accordion.active::after { transform: rotate(90deg); }
        
        .panel label, .panel span { color: var(--sidebar-text-color); display: block; margin-top: 15px; margin-bottom: 5px; }
        .panel select { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
        
        #municipio-search {
            width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box;
        }

        .checkbox-list { list-style: none; padding: 0; margin: 10px 0; }
        .checkbox-list li { margin-bottom: 10px; }
        .checkbox-list input { margin-right: 10px; }
        .chart-popup {
            position: absolute; top: 100px; left: 350px; width: 800px; height: 500px;
            background: white; border: 1px solid #ccc; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1005; border-radius: 8px; display: none; resize: both; overflow: auto;
        }
        .chart-popup-header { padding: 10px; cursor: move; background-color: #f1f1f1; color: #333; border-bottom: 1px solid #ddd; border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .chart-popup-header .close-btn { float: right; cursor: pointer; font-weight: bold; }
        .chart-popup-content { padding: 15px; height: calc(100% - 45px); }
        .map-view-selector { display: flex; justify-content: space-around; padding: 10px; background-color: #34495e; }
        .map-view-selector label { color: white; }
        
        .ui-autocomplete {
            z-index: 1003 !important;
        }
    </style>
</head>
<body>

    <button class="open-btn" onclick="toggleNav()">&#9776;</button>
    <div id="mySidebar" class="sidebar">
        <h2 style="color: white; text-align: center; margin-bottom: 20px;">Dashboard Criminal</h2>
        
        <div style="padding: 0 18px 15px 18px;">
            <label for="municipio-search" style="color: white; margin-bottom: 5px; display: block;">Buscar Município:</label>
            <input type="text" id="municipio-search" placeholder="Digite o nome do município...">
        </div>

        <button class="accordion">Filtros de Mapa</button>
        <div class="panel">
            <div class="panel-content">
                <div class="map-view-selector">
                    <label><input type="radio" name="mapView" value="municipality" checked> Municípios</label>
                    <label><input type="radio" name="mapView" value="ais"> AIS</label>
                </div>
                <label for="crime-select" style="margin-top: 15px;">Selecione o Tipo de Crime:</label>
                <select id="crime-select">
                    {% set crime_list = ['HOMICIDIO DOLOSO'] + (crimes | reject('equalto', 'HOMICIDIO DOLOSO') | list) %}
                    {% for crime in crime_list %}
                        <option value="{{ crime }}">{{ crime }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <button class="accordion">Visualizar Gráficos</button>
        <div class="panel">
            <div class="panel-content">
                <span class="sub-accordion">Crimes Gerais</span>
                <div class="sub-panel">
                    <div class="sub-panel-content">
                        <ul class="checkbox-list">
                            <li>
                                <label><input type="checkbox" class="chart-checkbox" data-chart-id="evolucao_anual" data-chart-title="Evolução Anual de Crimes por Gênero" data-chart-type="line"> Evolução Anual por Gênero</label>
                                <div class="sub-panel-item-content">
                                    <label for="evolucao-anual-predict" style="font-size: 12px;">Previsão Futura:</label>
                                    <select id="evolucao-anual-predict" class="chart-filter" data-target-chart="evolucao_anual">
                                        <option value="0">Sem Previsão</option>
                                        <option value="1">Prever 1 Ano</option>
                                        <option value="5">Prever 5 Anos</option>
                                        <option value="10">Prever 10 Anos</option>
                                    </select>
                                </div>
                            </li>
                            <li><label><input type="checkbox" class="chart-checkbox" data-chart-id="comparativo_crime_log" data-chart-title="Quantidade de Vítimas por Tipo de Crime" data-chart-type="bar"> Quantidade por Tipo de Crime</label></li>
                            <li><label><input type="checkbox" class="chart-checkbox" data-chart-id="proporcao_genero_crime" data-chart-title="Proporção de Gênero por Tipo de Crime" data-chart-type="bar" data-chart-stacked="true" data-chart-axis="y"> Proporção de Gênero por Crime</label></li>
                            <li><label><input type="checkbox" class="chart-checkbox" data-chart-id="distribuicao_raca" data-chart-title="Distribuição de Vítimas por Raça/Cor" data-chart-type="bar"> Distribuição por Raça/Cor</label></li>
                            <li><label><input type="checkbox" class="chart-checkbox" data-chart-id="densidade_etaria" data-chart-title="Distribuição de Densidade Etária das Vítimas" data-chart-type="line"> Distribuição de Densidade Etária</label></li>
                            <li><label><input type="checkbox" class="chart-checkbox" data-chart-id="comparativo_idade_genero" data-chart-title="Comparativo de Idade por Gênero" data-chart-type="line"> Comparativo de Idade por Gênero</label></li>
                        </ul>
                    </div>
                </div>
                <hr style="border-color: #444;">
                <span class="sub-accordion">Crimes Contra a Mulher</span>
                <div class="sub-panel">
                    <div class="sub-panel-content">
                        <ul class="checkbox-list">
                            <li><label><input type="checkbox" class="chart-checkbox" data-chart-id="crimes_mulher_dia_hora" data-chart-title="Crimes Contra Mulheres por Dia e Hora" data-chart-type="line"> Crimes por Dia e Hora</label></li>
                            <li><label><input type="checkbox" class="chart-checkbox" data-chart-id="distribuicao_raca_fem" data-chart-api-id="distribuicao_raca" data-gender-filter="feminino" data-chart-title="Distribuição por Raça/Cor (Vítimas Mulheres)" data-chart-type="bar"> Distribuição por Raça/Cor</label></li>
                            <li><label><input type="checkbox" class="chart-checkbox" data-chart-id="densidade_etaria_fem" data-chart-api-id="densidade_etaria" data-gender-filter="feminino" data-chart-title="Distribuição de Densidade Etária (Vítimas Mulheres)" data-chart-type="line"> Distribuição de Densidade Etária</label></li>
                        </ul>
                    </div>
                </div>
                <hr style="border-color: #444;">
                <span class="sub-accordion">Análise por Meio Empregado</span>
                <div class="sub-panel">
                    <div class="sub-panel-content">
                        <label for="meio-empregado-filter">Filtrar por Gênero:</label>
                        <select id="meio-empregado-filter" class="chart-filter" data-target-chart="proporcao_meio_empregado,evolucao_meio_empregado">
                            <option value="todos">Todos os Registros</option>
                            <option value="feminino">Apenas Vítimas Femininas</option>
                        </select>
                        <ul class="checkbox-list" style="margin-top: 15px;">
                            <li><label><input type="checkbox" class="chart-checkbox" data-chart-id="proporcao_meio_empregado" data-chart-title="Proporção do Meio Empregado" data-chart-type="pie"> Proporção (Pizza)</label></li>
                            <li><label><input type="checkbox" class="chart-checkbox" data-chart-id="evolucao_meio_empregado" data-chart-title="Evolução do Meio Empregado" data-chart-type="line"> Evolução Temporal (Linhas)</label></li>
                        </ul>
                    </div>
                </div>
                <hr style="border-color: #444;">
                <span class="sub-accordion">Análise de Crimes de Ódio</span>
                <div class="sub-panel">
                    <div class="sub-panel-content">
                        <ul class="checkbox-list">
                            <li><label><input type="checkbox" class="chart-checkbox" data-chart-id="evolucao_odio" data-chart-title="Evolução Anual dos Crimes de Ódio" data-chart-type="line"> Evolução Anual</label></li>
                            <li><label><input type="checkbox" class="chart-checkbox" data-chart-id="perfil_orientacao_sexual" data-chart-title="Perfil de Orientação Sexual (Vítimas de LGBTfobia)" data-chart-type="bar"> Perfil de Orientação Sexual</label></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="map"></div>
    <div id="chart-popup-template" style="display: none;">
        <div class="chart-popup">
            <div class="chart-popup-header"><span class="title"></span><span class="close-btn">&times;</span></div>
            <div class="chart-popup-content"><canvas></canvas></div>
        </div>
    </div>

    <script>
        // --- LÓGICA DA SIDEBAR (sem alterações) ---
        const sidebar = document.getElementById("mySidebar");
        const mapContainer = document.getElementById("map");
        const openBtn = document.querySelector(".open-btn");
        function toggleNav() {
            sidebar.classList.toggle("open");
            mapContainer.classList.toggle("sidebar-open");
            openBtn.classList.toggle("shifted");
            setTimeout(() => map.invalidateSize(), 300);
        }
        sidebar.classList.add("open");
        mapContainer.classList.add("sidebar-open");
        openBtn.classList.add("shifted");

        function setupAccordion(selector) {
            const elements = document.querySelectorAll(selector);
            elements.forEach(el => {
                el.addEventListener("click", function() {
                    this.classList.toggle("active");
                    const panel = this.nextElementSibling;
                    panel.classList.toggle('open');
                });
            });
        }
        setupAccordion('.accordion');
        setupAccordion('.sub-accordion');

        // --- LÓGICA DOS GRÁFICOS (sem alterações) ---
        Chart.register(ChartDataLabels);
        const activeCharts = {};
        $('.chart-checkbox').on('change', function() {
            const chartId = $(this).data('chart-id');
            if (this.checked) { createChartPopup(chartId); } else { destroyChartPopup(chartId); }
        });
        $('.chart-filter').on('change', function() {
            const targetCharts = $(this).data('target-chart').split(',');
            targetCharts.forEach(chartId => {
                if ($(`input[data-chart-id="${chartId}"]`).is(':checked')) {
                    destroyChartPopup(chartId);
                    createChartPopup(chartId);
                }
            });
        });
        async function createChartPopup(chartId) {
            const $checkbox = $(`input[data-chart-id="${chartId}"]`);
            const chartApiId = $checkbox.data('chart-api-id') || chartId;
            const chartTitle = $checkbox.data('chart-title');
            const chartType = $checkbox.data('chart-type') || 'line';
            const isStacked = $checkbox.data('chart-stacked') || false;
            const mainAxis = $checkbox.data('chart-axis') || 'x';
            const genderFilter = $checkbox.data('gender-filter');
            let finalChartTitle = chartTitle;
            let apiUrl = `/api/data/grafico_${chartApiId}`;
            let queryParams = [];
            if (genderFilter) { queryParams.push(`genero=${genderFilter}`); }
            $(`.chart-filter`).each(function() {
                const targets = $(this).data('target-chart').split(',');
                if (targets.includes(chartId) || targets.includes(chartApiId)) {
                    const filterValue = $(this).val();
                    const filterKey = this.id.includes('predict') ? 'predict' : 'filtro';
                    if (filterValue !== "0" || filterKey === 'filtro') { queryParams.push(`${filterKey}=${filterValue}`); }
                    if (filterKey === 'filtro') { finalChartTitle += ` (${$(this).find('option:selected').text()})`; }
                }
            });
            if (queryParams.length > 0) { apiUrl += `?${queryParams.join('&')}`; }
            const $popup = $('#chart-popup-template .chart-popup').clone().attr('id', 'popup-' + chartId);
            $popup.find('.title').text(finalChartTitle);
            $('body').append($popup);
            $popup.draggable({ handle: ".chart-popup-header" }).resizable();
            $popup.find('.close-btn').on('click', function() {
                $checkbox.prop('checked', false);
                destroyChartPopup(chartId);
            });
            try {
                const response = await fetch(apiUrl);
                const chartData = await response.json();
                const ctx = $popup.find('canvas')[0].getContext('2d');
                const chartOptions = {
                    responsive: true, maintainAspectRatio: false, indexAxis: mainAxis,
                    scales: { x: { stacked: isStacked }, y: { stacked: isStacked, beginAtZero: true } },
                    plugins: {
                        legend: { display: chartData.datasets.length > 1 && chartType !== 'pie' },
                        datalabels: {
                            formatter: (value, ctx) => {
                                if (chartType === 'pie') {
                                    let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    if (sum === 0) return '0%';
                                    return (value * 100 / sum).toFixed(1) + "%";
                                }
                                return Math.round(value);
                            },
                            color: '#fff', font: { weight: 'bold' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || context.label || '';
                                    if (label) { label += ': '; }
                                    if (isStacked && mainAxis === 'y') { label += parseFloat(context.raw).toFixed(2) + '%'; } 
                                    else { label += context.raw; }
                                    return label;
                                }
                            }
                        }
                    }
                };
                if (chartApiId === 'comparativo_crime_log') { chartOptions.scales.y.type = 'logarithmic'; }
                if (isStacked && mainAxis === 'y') { chartOptions.scales.x.max = 100; }
                if (!['proporcao_genero_crime'].includes(chartApiId) && chartType !== 'pie') {
                    chartOptions.plugins.datalabels.display = false;
                }
                if (chartType === 'line') {
                    chartData.datasets.forEach(dataset => {
                        dataset.pointRadius = 0;
                        dataset.borderWidth = 2;
                    });
                }
                activeCharts[chartId] = new Chart(ctx, { type: chartType, data: chartData, options: chartOptions });
                $popup.show();
            } catch (error) { console.error("Erro ao buscar dados do gráfico:", error); $popup.remove(); }
        }
        function destroyChartPopup(chartId) {
            if (activeCharts[chartId]) { activeCharts[chartId].destroy(); delete activeCharts[chartId]; }
            $('#popup-' + chartId).remove();
        }

        // --- LÓGICA DO MAPA (COM NOVO PADRÃO DE ZOOM) ---
        try {
            // MUDANÇA 1: Alterando o zoom inicial e mínimo para 8
            const map = L.map('map', { 
                center: [-5.2, -39.5], 
                zoom: 8, 
                minZoom: 8, 
                zoomControl: false,
                doubleClickZoom: false 
            });

            L.control.zoom({ position: 'bottomright' }).addTo(map);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>' } ).addTo(map);
            
            let geojsonLayer;
            let highlightedLayer = null;
            const highlightStyle = { weight: 3, color: '#00ffff', opacity: 1 };

            // MUDANÇA 2: Iniciando o ciclo de zoom em 8
            let currentZoomStep = 8;

            function getColor(t,m){const n=Number(t);if(isNaN(n)||n<=0)return'#E5E5E5';if(m===0)return'#ffffb2';const o=['#ffffb2','#fed976','#feb24c','#fd8d3c','#f03b20','#bd0026'];if(n>m*0.8)return o[5];if(n>m*0.6)return o[4];if(n>m*0.4)return o[3];if(n>m*0.2)return o[2];if(n>m*0.05)return o[1];return o[0]}
            
            function getFeatureStyle(feature, max_taxa) {
                const taxa = feature.properties.TAXA_POR_100K;
                return {
                    fillColor: getColor(taxa, max_taxa),
                    weight: 1,
                    opacity: 1,
                    color: 'black',
                    fillOpacity: 0.8
                };
            }
            
            function applyHighlight(layer) {
                if (highlightedLayer) {
                    geojsonLayer.resetStyle(highlightedLayer);
                }
                highlightedLayer = layer;
                layer.setStyle(highlightStyle);
                layer.bringToFront();
            }

            function removeHighlight() {
                if (highlightedLayer) {
                    geojsonLayer.resetStyle(highlightedLayer);
                    highlightedLayer = null;
                }
            }

            async function updateMap() {
                if (geojsonLayer) map.removeLayer(geojsonLayer);
                removeHighlight();
                const crimeType = $('#crime-select').val();
                const mapView = $('input[name="mapView"]:checked').val();
                const apiUrl = `/api/${mapView}_map_data/${crimeType}`;
                try {
                    const response = await fetch(apiUrl);
                    const data = await response.json();
                    const geojsonData = data.geojson;
                    const max_taxa = data.max_taxa;
                    geojsonLayer = L.geoJson(geojsonData, {
                        style: (feature) => getFeatureStyle(feature, max_taxa),
                        onEachFeature: function (feature, layer) {
                            const props = feature.properties;
                            const id_prop = mapView === 'ais' ? 'AIS' : 'name';
                            const name = props[id_prop] || "N/A";
                            const popupContent = `<h4>${name}</h4><b>Nº Absoluto:</b> ${Number(props.QUANTIDADE || 0).toFixed(0)}  
<b>Taxa/100k:</b> ${Number(props.TAXA_POR_100K || 0).toFixed(2)}`;
                            layer.bindPopup(popupContent);

                            layer.on('click', function(e) {
                                L.DomEvent.stopPropagation(e);
                                applyHighlight(layer);
                            });
                        }
                    }).addTo(map);
                } catch (error) { console.error('ERRO DENTRO DO updateMap:', error); }
            }
            $('#crime-select, input[name="mapView"]').on('change', updateMap);
            map.on('click', removeHighlight);

            map.on('dblclick', function() {
                currentZoomStep++;
                if (currentZoomStep > 11) {
                    // MUDANÇA 3: Volta para o início do ciclo em 8
                    currentZoomStep = 8; 
                }
                map.setZoom(currentZoomStep);
            });

            map.on('zoomend', function() {
                const currentMapZoom = map.getZoom();
                // MUDANÇA 4: Ajusta o range do ciclo
                if (currentMapZoom >= 8 && currentMapZoom <= 11) {
                    currentZoomStep = currentMapZoom;
                } else {
                    currentZoomStep = map.getZoom(); 
                }
            });

            $.getJSON('/api/municipalities', function(data) {
                const municipalities = data.map(m => ({ label: m.name, value: m.name, lat: m.lat, lon: m.lon }));
                $("#municipio-search").autocomplete({
                    source: municipalities,
                    select: function(event, ui) {
                        const mun = ui.item;
                        map.flyTo([mun.lat, mun.lon], 11);
                        
                        geojsonLayer.eachLayer(function(layer) {
                            if (layer.feature.properties.name === mun.value) {
                                applyHighlight(layer);
                            }
                        });
                        
                        $("#municipio-search").val('');
                        return false;
                    }
                });
            });

            document.querySelectorAll('.accordion').forEach(acc => { acc.click(); });
            setTimeout(() => map.invalidateSize(), 400);
            updateMap();
        } catch (e) { console.error("ERRO FATAL NA INICIALIZAÇÃO DO SCRIPT:", e); }
    </script>

</body>
</html>
